# 不锈钢期货蝴蝶套利策略

## 策略概述

本项目包含两个不锈钢期货交易策略：

### 1. 蝴蝶套利策略
这是一个基于机器学习预测的高频套利策略，通过同时开多开空（双开）和同时平多平空（双平）来捕捉不锈钢期货市场的短期价差机会。策略名称"蝴蝶"（Butterfly）形象地描述了同时持有多空双向头寸的交易模式。

### 2. 动量交易策略
这是一个基于短期价格动量的日内交易策略，通过识别价格的短期趋势进行单向交易，相比蝴蝶策略更加简单直接，降低了策略的复杂性和不确定性。详细说明请参考 [MOMENTUM_STRATEGY.md](MOMENTUM_STRATEGY.md)。

## 策略原理

### 核心思想
- 当市场出现特定的成交模式时，同时在买一价开多单、在卖一价开空单（双开）
- 持有双向头寸后，等待合适时机同时平仓获利（双平）
- 通过捕捉买卖价差（spread）的变化来获利

### 市场微观结构分析
策略通过分析tick数据中的成交量变化和持仓量变化来判断市场状态：
- **双开**：持仓量增加且成交量等于持仓量增加值
- **双平**：成交量增加且成交量等于持仓量减少的绝对值
- **开仓/平仓**：根据价格方向判断是开多、开空、平多还是平空

## 技术实现

### 1. 机器学习模型
使用XGBoost分类器预测交易机会，主要特征包括：

#### 价格特征
- `last_price`：最新价
- `highest`、`lowest`：最高价、最低价
- `bid_price1-5`、`ask_price1-5`：五档买卖盘口价格

#### 成交量特征
- `volume`、`volume_delta`：成交量及其变化
- `open_interest`、`open_interest_delta`：持仓量及其变化
- `bid_volume1-5`、`ask_volume1-5`：五档买卖盘口挂单量

#### 技术指标
- `rolling_mean`、`rolling_std`：价格的滚动均值和标准差
- `RSI`：相对强弱指标
- `MACD`、`MACD_signal`：MACD指标及信号线

#### 市场微观结构
- `trade_openclose`：开平仓状态（多开、空开、多平、空平、双开、双平等）
- `trade_color`：成交方向（红色-上涨、绿色-下跌、白色-不变）

### 2. 模型参数
```python
model = xgb.XGBClassifier(
    n_estimators=40,      # 树的个数
    max_depth=3,          # 树的深度
    learning_rate=0.1,    # 学习率
    subsample=0.8,        # 训练每棵树时使用的样本比例
    colsample_bytree=0.8, # 构建树时的列采样比例
)
```

## 交易逻辑

### 开仓条件
1. 模型预测概率 > 0.65（`trade_threshold`）
2. 买卖价差 = 5个最小变动价位（`trade_gap`）
3. 当前无持仓
4. 不在禁止交易时段（11:25-11:30, 14:55-15:00, 0:50-1:00）

### 平仓条件
1. 模型预测概率 > 0.65
2. 已持有双向头寸（多空各1手）
3. 买卖价差符合要求

### 执行细节
- **双开执行**：同时下限价买单和限价卖单
- **双平执行**：同时下限价平多单和限价平空单
- **超时处理**：100个tick内未完全成交则取消订单

## 风险控制

### 止损机制
1. **单边成交止损**：
   - 买单成交但卖单未成交，若买价下跌则立即平仓
   - 卖单成交但买单未成交，若卖价上涨则立即平仓

2. **超时止损**：
   - 超过100个tick仍未完全成交，取消未成交订单并平仓

### 资金管理
- 每次交易固定1手（`trade_hand = 1`）
- 当日亏损超过120元停止交易
- 使用锁机制（`lock`）防止重复下单

## 策略参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `window_size` | 200 | 特征计算的窗口大小 |
| `trade_threshold` | 0.65 | 交易信号阈值 |
| `trade_hand` | 1 | 每次交易手数 |
| `trade_gap` | 5 | 买卖价差要求 |
| `guess_tick` | 100 | 等待成交的最大tick数 |

## 文件说明

### 蝴蝶套利策略
- `tianqin_simu_butterfly.py`：主策略实时交易程序
- `future_butterfly_test.ipynb`：数据预处理和标注程序
- `future_butterfly_simu.ipynb`：策略回测程序
- `future_butterfly_lstm.ipynb`：LSTM模型版本
- `future_taobao_ssMain_tick_with_opportunities.csv`：标注后的训练数据

### 动量交易策略
- `momentum_strategy.py`：动量策略实时交易程序
- `momentum_backtest.py`：动量策略回测程序
- `MOMENTUM_STRATEGY.md`：动量策略详细说明文档

## 使用方法

### 1. 数据准备
```bash
# 运行数据标注程序
jupyter notebook future_butterfly_test.ipynb
```

### 2. 模型训练
策略会自动加载预处理后的数据并训练XGBoost模型

### 3. 实盘/模拟交易
```bash
# 运行主策略程序
python tianqin_simu_butterfly.py
```

### 4. 账户配置
```python
# 模拟账户
sim = TqSim(init_balance=20000)
api = TqApi(sim, auth=TqAuth("用户名", "密码"))

# 实盘账户
api = TqApi(TqAccount("期货公司", "账号", "密码"), auth=TqAuth("用户名", "密码"))
```

## 注意事项

1. **市场选择**：策略适用于流动性好、买卖价差稳定的期货品种
2. **滑点控制**：实盘交易需考虑滑点影响，可调整`trade_slippy`参数
3. **网络延迟**：高频交易对网络延迟敏感，建议使用稳定的网络环境
4. **风险提示**：任何交易策略都存在风险，请谨慎使用并做好风险管理

## 策略优化方向

1. **特征工程**：增加更多市场微观结构特征
2. **模型优化**：尝试其他机器学习算法如LightGBM、深度学习等
3. **执行优化**：改进订单执行算法，减少市场冲击
4. **风控优化**：动态调整止损阈值和仓位大小
5. **多品种扩展**：将策略应用到其他流动性好的期货品种

## 性能指标

策略的主要评估指标：
- **双开双平成功率**：成功完成双开双平的比例
- **平均持仓时间**：从开仓到平仓的平均tick数
- **日内最大回撤**：当日最大亏损金额
- **夏普比率**：风险调整后的收益率

## 联系方式

如有问题或建议，请通过以下方式联系：
- 策略相关问题请在项目中提issue
- 实盘使用请充分测试并自担风险 